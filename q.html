<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Generator with QR Code</title>
  <style>

    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    #canvasContainer {
      position: relative;
      width: 80vw; /* Adjust width as needed */
      margin: auto;
    }

    canvas, img {
      display: block;
      margin: auto;
      max-width: 100%;
    }

    #downloadButton, #introButton {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Content Generator with QR Code</h1>

  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>

  <button id="downloadButton">Download Image</button>
  <button id="introButton" onclick="redirectToIntro()">Project Introduction</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script>
    var uid = "202402290222"; // Replace with actual UID
    var canvas = document.getElementById('canvas'); // Get canvas element globally

    // Load content based on UID
    fetch('https://raw.githubusercontent.com/TongSUE/testfile/gh-pages/content.json')
      .then(response => response.json())
      .then(data => {
        var content = data[uid];
        if (content) {
          generateImage(content);
          generateQRCode();
        } else {
          alert('Content not found!');
        }
      })
      .catch(error => console.error('Error:', error));

    function generateImage(content) {
      var ctx = canvas.getContext('2d'); // Get canvas context

      // Load template image
      var templateImg = new Image();
      templateImg.onload = function() {
        // Resize template image
        var scaleFactor = Math.min(canvasContainer.offsetWidth / templateImg.width, window.innerHeight / templateImg.height);
        canvas.width = templateImg.width * scaleFactor;
        canvas.height = templateImg.height * scaleFactor;
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);

        // Load other image
        var otherImg = new Image();
        otherImg.onload = function() {
          // Calculate position and size of other image
          var imageSize = Math.min(canvas.width / 2, canvas.height / 2); // Adjust size as needed
          var imageX = (canvas.width - imageSize) / 2;
          var imageY = (canvas.height - imageSize) / 2;
          // Draw other image
          ctx.drawImage(otherImg, imageX, imageY, imageSize, imageSize);

          // Draw text
          ctx.font = 'bold 50px Helvetica';;
          ctx.fillStyle = 'rgba(0,0,255,1)';
          ctx.textAlign = 'center';
          ctx.fillText(content.text, canvas.width / 2, 200); // Adjust position as needed

          // Generate QR code after drawing everything
          generateQRCode([0, 0, 255], [255, 255, 255]); // 使用红色前景色和白色背景色


        };
        otherImg.src = content.imageUrl;
      };
      templateImg.src = content.templateUrl;
    }

    function generateQRCode(foregroundColor, backgroundColor) {
  var ctx = canvas.getContext('2d');
  var qr = qrcode(0, 'L');
  var url = 'https://tongsue.github.io/testfile/q.html?uid=' + uid;
  qr.addData(url);
  qr.make();
  var qrData = qr.createDataURL(4, 0);

  // 创建一个 Image 元素来加载二维码数据
  var qrImg = new Image();
  qrImg.onload = function() {
    // 创建一个临时 canvas 来绘制二维码
    var tempCanvas = document.createElement('canvas');
    var tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = qrImg.width;
    tempCanvas.height = qrImg.height;
    tempCtx.drawImage(qrImg, 0, 0);
    
    // 获取二维码图像的像素数据
    var imgData = tempCtx.getImageData(0, 0, qrImg.width, qrImg.height);
    var pixels = imgData.data;

    // 修改像素颜色
    for (var i = 0; i < pixels.length; i += 4) {
      // 如果像素是黑色，则替换为前景色
      if (pixels[i] < 128) {
        pixels[i] = foregroundColor[0];
        pixels[i + 1] = foregroundColor[1];
        pixels[i + 2] = foregroundColor[2];
        pixels[i + 3] = 255; // 不透明
      } else { // 否则替换为背景色
        pixels[i] = backgroundColor[0];
        pixels[i + 1] = backgroundColor[1];
        pixels[i + 2] = backgroundColor[2];
        pixels[i + 3] = 255; // 不透明
      }
    }

    // 将修改后的像素数据放回临时 canvas
    tempCtx.putImageData(imgData, 0, 0);

    // 将临时 canvas 中的图像绘制到主 canvas 上
    ctx.drawImage(tempCanvas, 20, canvas.height - tempCanvas.height - 20); // 调整二维码的位置
  };

  qrImg.src = qrData;
}



    function downloadImage() {
      var image = canvas.toDataURL('image/jpeg');
      var link = document.createElement('a');
      link.href = image;
      link.download = 'generated_image.jpg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function redirectToIntro() {
      window.location.href = 'https://tongsue.github.io/testfile/Intro.html';
    }
  </script>
</body>
</html>
