<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Generator with QR Code</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    #canvasContainer {
      position: relative;
      width: 80vw; /* Adjust width as needed */
      margin: auto;
    }

    canvas, img {
      display: block;
      margin: auto;
      max-width: 100%;
    }

    #downloadButton, #introButton {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Content Generator with QR Code</h1>

  <div id="canvasContainer">
    <canvas id="canvas"></canvas>
  </div>

  <button id="downloadButton">Download Image</button>
  <button id="introButton" onclick="redirectToIntro()">Project Introduction</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script>
    var uid = "202402290222"; // Replace with actual UID

    // Load content based on UID
    fetch('https://raw.githubusercontent.com/TongSUE/testfile/gh-pages/content.json')
      .then(response => response.json())
      .then(data => {
        var content = data[uid];
        if (content) {
          generateImage(content);
          generateQRCode();
        } else {
          alert('Content not found!');
        }
      })
      .catch(error => console.error('Error:', error));

    function generateImage(content) {
      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext('2d');

      // Load template image
      var templateImg = new Image();
      templateImg.onload = function() {
        // Resize template image
        var scaleFactor = Math.min(canvasContainer.offsetWidth / templateImg.width, window.innerHeight / templateImg.height);
        canvas.width = templateImg.width * scaleFactor;
        canvas.height = templateImg.height * scaleFactor;
        ctx.drawImage(templateImg, 0, 0, canvas.width, canvas.height);

        // Load other image
        var otherImg = new Image();
        otherImg.onload = function() {
          // Calculate position and size of other image
          var imageSize = Math.min(canvas.width / 2, canvas.height / 2); // Adjust size as needed
          var imageX = (canvas.width - imageSize) / 2;
          var imageY = (canvas.height - imageSize) / 2;
          // Draw other image
          ctx.drawImage(otherImg, imageX, imageY, imageSize, imageSize);

          // Draw text
          ctx.font = '20px Arial';
          ctx.fillStyle = 'rgb(0, 0, 255)';
          ctx.textAlign = 'center';
          ctx.fillText(content.text, canvas.width / 2, 30); // Adjust position as needed

          // Generate QR code after drawing everything
          generateQRCode(canvas);
        };
        otherImg.src = content.imageUrl;
      };
      templateImg.src = content.templateUrl;
    }

    function generateQRCode(canvas) {
      var ctx = canvas.getContext('2d');
      var qr = qrcode(0, 'L');
      var url = 'https://tongsue.github.io/testfile/q.html?uid=' + uid;
      qr.addData(url);
      qr.make();
      var qrData = qr.createDataURL(4, 0);
      var qrImg = new Image();
      qrImg.onload = function() {
        ctx.drawImage(qrImg, 20, canvas.height - qrImg.height - 20); // Adjust position as needed
      };
      qrImg.src = qrData;
    }

    function downloadImage(canvas) {
      var image = canvas.toDataURL('image/jpeg');
      var link = document.createElement('a');
      link.href = image;
      link.download = 'generated_image.jpg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function redirectToIntro() {
      window.location.href = 'https://tongsue.github.io/testfile/Intro.html';
    }
  </script>
</body>
</html>
